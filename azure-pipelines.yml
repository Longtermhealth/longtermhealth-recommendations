trigger:
- main

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: 'a4f04d2d-a3e1-40ae-80aa-321005f23c28'
  imageRepository: 'lthrecommendations'
  containerRegistry: 'lthrecommendations.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
        buildArgs: |
          CLICKUP_API_KEY=$(CLICKUP_API_KEY)
          CLICKUP_LIST_ID=$(CLICKUP_LIST_ID)
          SCORES_FIELD_ID=$(SCORES_FIELD_ID)
          PLOT_FIELD_ID=$(PLOT_FIELD_ID)
          ANSWERS_FIELD_ID=$(ANSWERS_FIELD_ID)
          ROUTINES_FIELD_ID=$(ROUTINES_FIELD_ID)
          ACTIONPLAN_FIELD_ID=$(ACTIONPLAN_FIELD_ID)
          TYPEFORM_API_KEY=$(TYPEFORM_API_KEY)
          STRAPI_API_KEY=$(STRAPI_API_KEY)
          FORM_ID=$(FORM_ID)
          AZURE_BLOB_CONNECTION_STRING=$(AZURE_BLOB_CONNECTION_STRING)
      env:
        CLICKUP_API_KEY: $(CLICKUP_API_KEY)
        CLICKUP_LIST_ID: $(CLICKUP_LIST_ID)
        SCORES_FIELD_ID: $(SCORES_FIELD_ID)
        PLOT_FIELD_ID: $(PLOT_FIELD_ID)
        ANSWERS_FIELD_ID: $(ANSWERS_FIELD_ID)
        ROUTINES_FIELD_ID: $(ROUTINES_FIELD_ID)
        ACTIONPLAN_FIELD_ID: $(ACTIONPLAN_FIELD_ID)
        TYPEFORM_API_KEY: $(TYPEFORM_API_KEY)
        STRAPI_API_KEY: $(STRAPI_API_KEY)
        FORM_ID: $(FORM_ID)
        AZURE_BLOB_CONNECTION_STRING: $(AZURE_BLOB_CONNECTION_STRING)
